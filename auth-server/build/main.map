{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/auth/index.js","webpack:///./src/auth/router.js","webpack:///./src/auth/userStore.js","webpack:///./src/index.js","webpack:///./src/movie/index.js","webpack:///./src/movie/movieStore.js","webpack:///./src/movie/router.js","webpack:///./src/utils/constants.js","webpack:///./src/utils/index.js","webpack:///./src/utils/middlewares.js","webpack:///./src/utils/wss.js","webpack:///external \"@koa/cors\"","webpack:///external \"http\"","webpack:///external \"jsonwebtoken\"","webpack:///external \"koa\"","webpack:///external \"koa-bodyparser\"","webpack:///external \"koa-jwt\"","webpack:///external \"koa-router\"","webpack:///external \"nedb-promise\"","webpack:///external \"ws\""],"names":["router","Router","createToken","user","jwt","sign","username","_id","jwtConfig","secret","expiresIn","createUser","response","userStore","insert","body","token","status","err","issue","error","message","post","ctx","request","credentials","findOne","password","UserStore","constructor","filename","autoload","store","dataStore","props","app","Koa","server","http","createServer","callback","wss","WebSocket","Server","initWss","use","cors","timingLogger","exceptionHandler","bodyParser","prefix","publicApiRouter","authRouter","routes","allowedMethods","protectedApiRouter","movieRouter","listen","console","log","MovieStore","find","movie","movieName","name","Error","update","get","userId","state","movies","movieStore","userID","createMovie","responseMovie","broadcast","type","payload","context","put","id","params","movieId","updatedCount","version","header","serverMovie","Date","parse","toUTCString","localMovies","versionConflicts","i","length","localMovie","inRepo","startsWith","undefined","lng","lat","photoURL","description","title","date","inRepoVersion","localVersion","push","del","remove","next","start","now","method","url","value","on","ws","JSON","close","verify","data","clients","forEach","client","readyState","OPEN","send","stringify"],"mappings":"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","file":"main.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","export * from './router';","import Router from 'koa-router';\r\nimport userStore from './userStore';\r\nimport jwt from 'jsonwebtoken';\r\nimport { jwtConfig } from '../utils';\r\n\r\nexport const router = new Router();\r\n\r\nconst createToken = (user) => {\r\n    return jwt.sign({ username: user.username, _id: user._id }, jwtConfig.secret, { expiresIn: 60 * 60 * 60 });\r\n};\r\n\r\nconst createUser = async (user, response) => {\r\n    try {\r\n        await userStore.insert(user);\r\n        response.body = { token: createToken(user) };\r\n        response.status = 201; // created\r\n    } catch (err) {\r\n        response.body = { issue: [{ error: err.message }] };\r\n        response.status = 400; // bad request\r\n    }\r\n};\r\n\r\nrouter.post('/signup', async (ctx) => await createUser(ctx.request.body, ctx.response));\r\n\r\nrouter.post('/login', async (ctx) => {\r\n    const credentials = ctx.request.body;\r\n    const response = ctx.response;\r\n    const user = await userStore.findOne({ username: credentials.username });\r\n    if (user && credentials.password === user.password) {\r\n        response.body = { token: createToken(user) };\r\n        response.status = 201; // created\r\n    } else {\r\n        response.body = { issue: [{ error: 'Invalid credentials' }] };\r\n        response.status = 400; // bad request\r\n    }\r\n});\r\n","import dataStore from 'nedb-promise';\r\n\r\nexport class UserStore {\r\n    constructor({ filename, autoload }) {\r\n        this.store = dataStore({ filename, autoload });\r\n    }\r\n\r\n    async findOne(props) {\r\n        return this.store.findOne(props);\r\n    }\r\n\r\n    async insert(user) {\r\n        return this.store.insert(user);\r\n    };\r\n}\r\n\r\nexport default new UserStore({ filename: './db/users.json', autoload: true });","import Koa from 'koa';\r\nimport WebSocket from 'ws';\r\nimport http from 'http';\r\nimport Router from 'koa-router';\r\nimport bodyParser from 'koa-bodyparser';\r\nimport jwt from 'koa-jwt';\r\nimport cors from '@koa/cors';\r\nimport {initWss, timingLogger, exceptionHandler, jwtConfig} from './utils';\r\nimport { router as movieRouter } from './movie';\r\nimport { router as authRouter } from './auth';\r\n\r\nconst app = new Koa();\r\nconst server = http.createServer(app.callback());\r\nconst wss = new WebSocket.Server({server});\r\ninitWss(wss);\r\n\r\napp.use(cors());\r\napp.use(timingLogger);\r\napp.use(exceptionHandler);\r\napp.use(bodyParser());\r\n\r\nconst prefix = '/api';\r\n\r\nconst publicApiRouter = new Router({prefix});\r\npublicApiRouter\r\n.use('/auth', authRouter.routes());\r\napp\r\n.use(publicApiRouter.routes())\r\n.use(publicApiRouter.allowedMethods());\r\n\r\napp.use(jwt(jwtConfig));\r\n\r\nconst protectedApiRouter = new Router({ prefix });\r\nprotectedApiRouter\r\n    .use('/movies', movieRouter.routes());\r\napp\r\n    .use(protectedApiRouter.routes())\r\n    .use(protectedApiRouter.allowedMethods());\r\n\r\nserver.listen(3000);\r\nconsole.log('started on port 3000');","export * from './router';","import dataStore from 'nedb-promise';\r\n\r\nexport class MovieStore{\r\n    constructor({filename, autoload}){\r\n        this.store = dataStore({filename, autoload});\r\n    }\r\n\r\n    async find(props) {\r\n        return this.store.find(props);\r\n    }\r\n\r\n    async findOne(props) {\r\n        return this.store.findOne(props);\r\n    }\r\n\r\n    async insert(movie) {\r\n        let movieName = movie.name;\r\n        if(!movieName){\r\n            throw new Error('Missing movie name!');\r\n        }\r\n        return this.store.insert(movie);\r\n    }\r\n\r\n    async update(props, movie){\r\n        return this.store.update(props, movie);\r\n    }\r\n}\r\n\r\nexport default new MovieStore({filename: './db/movies.json', autoload: true});","import Router from 'koa-router';\r\nimport movieStore from \"./movieStore\";\r\nimport {broadcast} from \"../utils\";\r\n\r\nexport const router = new Router();\r\n\r\nrouter.get('/', async (ctx) => {\r\n    const response = ctx.response;\r\n    const userId = ctx.state.user._id;\r\n    let movies = await movieStore.find({userID: userId});\r\n    response.body = movies;\r\n    response.status = 200;\r\n});\r\n\r\nconst createMovie = async (ctx, movie, response) => {\r\n    try {\r\n        let userId = ctx.state.user._id;\r\n        movie.userId = userId;\r\n        let responseMovie = await movieStore.insert(movie);\r\n        response.body = responseMovie;\r\n        response.status = 201;\r\n        movie._id = responseMovie._id;\r\n        broadcast(userId, {type: 'created', payload: movie});\r\n    } catch (error) {\r\n        response.body = {message: error.message};\r\n        response.status = 400;\r\n    }\r\n}\r\n\r\nrouter.post('/', async context => {\r\n    await (createMovie(context, context.request.body, context.response))\r\n});\r\n\r\nrouter.put('/:id', async (context) => {\r\n    const movie = context.request.body;\r\n    const id = context.params.id;\r\n    const movieId = movie._id;\r\n    const response = context.response;\r\n\r\n    if (movieId && movieId != id) {\r\n        response.body = {message: \"Movie id and parameter id has to be the same.\"};\r\n        response.status = 400;\r\n    }\r\n\r\n    if (!movieId) {\r\n        await createMovie(context, movie, response);\r\n    } else {\r\n        movie.userId = context.state.user._id;\r\n        const updatedCount = await movieStore.update({_id: id}, movie);\r\n        if (updatedCount === 1) {\r\n            response.body = movie;\r\n            response.status = 200;\r\n        } else {\r\n            response.body = {message: \"The movie no longer exists.\"};\r\n            response.status = 405;\r\n        }\r\n    }\r\n})\r\n\r\nrouter.get('/conflict/:id', async (context) => {\r\n    const response = context.response;\r\n    let userID = context.state.user._id;\r\n    let id = context.params.id\r\n    let version = context.header['if-modified-since']\r\n    let serverMovie = await movieStore.findOne({_id: id});\r\n    if (Date.parse(serverMovie.version) >= Date.parse(version)) {\r\n        response.status = 200\r\n        response.body = serverMovie\r\n    } else {\r\n        response.status = 304\r\n    }\r\n\r\n});\r\n\r\nrouter.put('/conflict/:id', async (context) => {\r\n    const movie = context.request.body;\r\n    const userID = context.state.user._id\r\n    const id = context.params.id;\r\n    const response = context.response;\r\n    movie.userID = userID\r\n    movie.version = new Date().toUTCString()\r\n    const updatedCount = await movieStore.update({_id: id}, movie);\r\n    if (updatedCount === 1) {\r\n        response.body = movie;\r\n        response.status = 200;\r\n        broadcast(userID, {type: 'resolvedConflict', payload: movie});\r\n    } else {\r\n        response.body = {message: 'Movie no longer exists'};\r\n        response.status = 405;\r\n    }\r\n});\r\n\r\nrouter.post('/sync', async (context) => {\r\n    const localMovies = context.request.body;\r\n    const userID = context.state.user._id;\r\n    const response = context.response;\r\n    let versionConflicts = [];\r\n    for (let i = 0; i < localMovies.length; i++) {\r\n        let localMovie = localMovies[i];\r\n        localMovie.userID = userID;\r\n        let inRepo = await movieStore.findOne({_id: localMovie._id});\r\n        if (localMovie._id.startsWith(\"_\") && !inRepo) {\r\n            localMovie._id = undefined;\r\n            await movieStore.insert(localMovie)\r\n        } else {\r\n            if (inRepo && (inRepo.lng !== localMovie.lng || inRepo.lat !== localMovie.lat || inRepo.photoURL !== localMovie.photoURL || inRepo.description !== localMovie.description || inRepo.title !== localMovie.title || inRepo.date !== localMovie.date)) {\r\n                let inRepoVersion = Date.parse(inRepo.version)\r\n                let localVersion = Date.parse(localMovie.version)\r\n                if (inRepoVersion >= localVersion) versionConflicts.push(localMovie._id)\r\n                else await movieStore.update({_id: localMovie._id}, localMovie)\r\n            }\r\n        }\r\n    }\r\n    if (versionConflicts.length > 0) {\r\n        response.body = versionConflicts\r\n        response.status = 409\r\n    } else {\r\n        response.body = versionConflicts\r\n        response.status = 201\r\n    }\r\n\r\n});\r\n\r\nrouter.del('/:id', async (context) => {\r\n    const userID = context.state.user._id;\r\n    const movie = await movieStore.findOne({_id: context.params.id});\r\n    if (movie && userID !== movie.userID) {\r\n        context.response.status = 403;\r\n    } else {\r\n        await movieStore.remove({_id: context.params.id});\r\n        context.response.status = 204;\r\n    }\r\n});","export const jwtConfig = { secret: 'my-secret' };\r\n","export * from './constants';\r\nexport * from './middlewares';\r\nexport * from './wss';\r\n","export const exceptionHandler = async (ctx, next) => {\r\n    try {\r\n        return await next();\r\n    } catch (err) {\r\n        ctx.body = { message: err.message || 'Unexpected error.' };\r\n        ctx.status = err.status || 500;\r\n    }\r\n};\r\n\r\nexport const timingLogger = async (ctx, next) => {\r\n    const start = Date.now();\r\n    await next();\r\n    console.log(`${ctx.method} ${ctx.url} => ${ctx.response.status}, ${Date.now() - start}ms`);\r\n};\r\n","import WebSocket from \"ws\";\r\nimport jwt from \"jsonwebtoken\";\r\nimport { jwtConfig } from \"./constants\";\r\n\r\nlet wss;\r\n\r\nexport const initWss = value => {\r\n    wss = value;\r\n    wss.on('connection', ws => {\r\n        ws.on('message', message => {\r\n            const { type, payload: { token } } = JSON.parse(message);\r\n            if (type !== 'authorization') {\r\n                ws.close();\r\n                return;\r\n            }\r\n            try {\r\n                ws.user = jwt.verify(token, jwtConfig.secret);\r\n            } catch (err) {\r\n                ws.close();\r\n            }\r\n        })\r\n    });\r\n};\r\n\r\nexport const broadcast = (userId, data) => {\r\n    if (!wss) {\r\n        return;\r\n    }\r\n    wss.clients.forEach(client => {\r\n        if (client.readyState === WebSocket.OPEN && userId === client.user._id) {\r\n            console.log(`broadcast sent to ${client.user.username}`);\r\n            client.send(JSON.stringify(data));\r\n        }\r\n    });\r\n};\r\n","module.exports = require(\"@koa/cors\");","module.exports = require(\"http\");","module.exports = require(\"jsonwebtoken\");","module.exports = require(\"koa\");","module.exports = require(\"koa-bodyparser\");","module.exports = require(\"koa-jwt\");","module.exports = require(\"koa-router\");","module.exports = require(\"nedb-promise\");","module.exports = require(\"ws\");"],"sourceRoot":""}